@Library('jenkins-shared-lib') _

pipeline {
  agent any
  environment {
    IMAGE_NAME = "yasminsalah1/myapp"
    IMAGE_TAG = "latest"
  }
  stages {
    stage('Build Image') {
      steps {
        script {
          buildImage(IMAGE_NAME, IMAGE_TAG)
        }
      }
    }
    stage('Scan Image') {
      steps {
        script {
          scanImage(IMAGE_NAME, IMAGE_TAG)
        }
      }
    }
    stage('Push Image') {
      steps {
        script {
          pushImage(IMAGE_NAME, IMAGE_TAG)
        }
      }
    }
    stage('Delete Local Image') {
      steps {
        sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG} || true"
      }
    }
    stage('Update Manifests') {
      steps {
        sh "sed -i 's|image: .*|image: ${IMAGE_NAME}:${IMAGE_TAG}|' k8s/deployment.yaml"
      }
    }
    stage('Push Manifests') {
      steps {
        sh """
          git config --global user.email "jenkins@example.com"
          git config --global user.name "Jenkins CI"
          git add k8s/deployment.yaml
          git commit -m "Update image tag to ${IMAGE_TAG}"
          git push origin main
        """
      }
    }
  }
}

